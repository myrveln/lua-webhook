name: Webhook Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Compose
      uses: docker/setup-compose-action@v1
      with:
        version: latest

    - name: Start services
      run: bash .github/scripts/compose_up.sh 60

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'

    - name: Install dependencies
      run: |
        cd tests
        pip install -r requirements.txt

    - name: Run tests
      env:
        BASE_URL: http://localhost:8080/webhook
      run: |
        cd tests
        # First pass (no-auth). Write coverage data, but defer XML generation
        # until after the auth-enabled pass so we can merge results.
        pytest test_webhook.py test_events.py test_ws.py -v --cov=. --cov-report=

    - name: Stop services (no-auth)
      if: always()
      run: docker compose down

    - name: Start services (auth enabled)
      env:
        WEBHOOK_API_KEYS: test-api-key
        WEBHOOK_AUTH_EXEMPT: _stats
      run: bash .github/scripts/compose_up.sh 60

    - name: Run auth tests
      env:
        BASE_URL: http://localhost:8080/webhook
        WEBHOOK_TEST_API_KEY: test-api-key
      run: |
        cd tests
        # Second pass (auth enabled). Append to existing coverage data.
        pytest test_webhook.py test_events.py test_ws.py test_auth.py -v --cov=. --cov-append --cov-report=

    - name: Generate merged coverage.xml
      if: always()
      run: |
        cd tests
        coverage xml -o coverage.xml

    - name: Coverage summary
      if: always()
      run: |
        python .github/scripts/coverage_summary.py tests/coverage.xml

    - name: Upload coverage artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml
        path: tests/coverage.xml
        if-no-files-found: warn

    - name: Show logs on failure
      if: failure()
      run: docker compose logs

    - name: Stop services
      if: always()
      run: docker compose down

    - name: Upload coverage
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
      uses: codecov/codecov-action@v5
      with:
        files: tests/coverage.xml
